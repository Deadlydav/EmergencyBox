## EmergencyBox lighttpd Configuration
## Optimized for ASUS RT-AC68U with large file support

server.modules = (
    "mod_access",
    "mod_alias",
    "mod_fastcgi",
    "mod_rewrite",
    "mod_setenv"
)

server.document-root = "/opt/share/www"
server.upload-dirs = ( "/tmp" )
server.errorlog = "/opt/var/log/lighttpd/error.log"
server.pid-file = "/opt/var/run/lighttpd.pid"
server.username = "nobody"
server.groupname = "nogroup"
server.port = 80

# MIME types
mimetype.assign = (
    ".html" => "text/html",
    ".htm" => "text/html",
    ".css" => "text/css",
    ".js" => "application/javascript",
    ".json" => "application/json",
    ".txt" => "text/plain",
    ".jpg" => "image/jpeg",
    ".jpeg" => "image/jpeg",
    ".png" => "image/png",
    ".gif" => "image/gif",
    ".svg" => "image/svg+xml",
    ".pdf" => "application/pdf",
    ".zip" => "application/zip",
    ".mp4" => "video/mp4",
    ".mp3" => "audio/mpeg",
    "" => "application/octet-stream"
)

# Index files
index-file.names = ( "index.html", "index.php" )

# FastCGI for PHP
fastcgi.server = (
    ".php" => (
        "localhost" => (
            "socket" => "/tmp/php-fastcgi.socket",
            "bin-path" => "/opt/bin/php-cgi",
            "bin-environment" => (
                "PHP_FCGI_CHILDREN" => "2",
                "PHP_FCGI_MAX_REQUESTS" => "1000"
            ),
            "broken-scriptfilename" => "enable",
            "max-procs" => 2,
            "idle-timeout" => 600
        )
    )
)

# Large file support - disable buffering
server.max-request-size = 5368709120  # 5GB in bytes
server.network-backend = "writev"

# Timeouts for large uploads
server.max-write-idle = 600
server.max-read-idle = 600

# Connection limits
server.max-connections = 50
server.max-fds = 256

# Static file caching
$HTTP["url"] =~ "\.(css|js|jpg|jpeg|png|gif|svg|ico)$" {
    expire.url = ( "" => "access plus 1 hours" )
}

# Directory listing disabled
dir-listing.activate = "disable"

# Access restrictions
$HTTP["url"] =~ "^/config/" {
    url.access-deny = ( "" )
}

$HTTP["url"] =~ "^/data/" {
    url.access-deny = ( "" )
}

# Allow uploads directory access
alias.url = (
    "/uploads/" => "/opt/share/www/uploads/"
)
